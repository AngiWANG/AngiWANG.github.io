---
layout: post
title: "实践MyBatis"
date: 2018-01-04 10:40:00 +0800
categories: Java
tags: database MyBatis JDBC ORM
---

[MyBatis](http://www.mybatis.org/mybatis-3/)【[MyBatis Blog](http://blog.mybatis.org/)】，前身是iBatis，是一个ORM框架，半自动

## mybatis-config.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
    <settings>
        <setting name="mapUnderscoreToCamelCase" value="true"/>
    </settings>
    <!-- 别名 -->
    <typeAliases>
        <package name="wang.angi.sample.mybatis.spring.boot.starter.domain"/>
    </typeAliases>
   <environments default="development">
     <environment id="development">
       <transactionManager type="JDBC"/>
       <dataSource type="POOLED">
         <property name="driver" value="${driver}"/>
         <property name="url" value="${url}"/>
         <property name="username" value="${username}"/>
         <property name="password" value="${password}"/>
       </dataSource>
     </environment>
   </environments>
   <mappers>
    <mapper resource="org/mybatis/example/BlogMapper.xml"/>
  </mappers>
</configuration>

```



```xml
<!ELEMENT configuration (properties?, settings?, typeAliases?, typeHandlers?, objectFactory?, objectWrapperFactory?, reflectorFactory?, plugins?, environments?, databaseIdProvider?, mappers?)>
```

### properties

```xml
<properties>
	<!-- 子元素 -->
	<property name="driver" value="com.mysql.jdbc.Driver"/>
</properties>
<!-- properties配置文件 -->
<properties resource="jdbc.properties"/>
<properties url="file:///properties/jdbc.properties"/>
```

### settings

```xml
<settings>
	<setting name="cachedEnabled" value="true"/>
</settings>
```

### typeAliases

MyBatis默认定义了一系列系统别名，也可以自定义别名，别名可以在MyBatis上下文中使用。不区分大小写。

```xml
<typeAliases>
    <!-- 精确定义 -->
	<typeAlias alias="role" type="wang.angi.sample.mybatis.dto.Role"/>
</typeAliases>

<typeAliases>
  	<!-- 基于扫描定义 -->
	<typeAlias package="wang.angi.sample.mybatis.dto"/>
</typeAliases>
```

### typeHandlers

类型处理器，在设置参数或结果集映射时会进行类型转换，主要是Java类型和JDBC类型（`org.apache.ibatis.type.JdbcType`）的互相转换，MyBatis默认定义了一系列系统类型处理器，也可以自定义类型处理器。

自定义类型处理器需要实现接口：`org.apache.ibatis.type.TypeHandler`，MyBatis默认抽象实现：`org.apache.ibatis.type.BaseTypeHandler`

```xml
<typeHandlers>
  	<typeHandler jdbcType="VARCHAR" javaType="string" handler="wang.angi.sample.mybatis.typehandler.MyStringTypeHandler"/>
</typeHandlers>
```

#### 枚举类型TypeHandler

EnumOrdinalTypeHandler：基于枚举下标传递参数

EnumTypeHandler：基于枚举名称传递参数

### objectFactory

当将结果集映射到POJO时，会基于ObjectFactory去构建。一般而言MyBatis默认定义的ObjectFactory可以满足需求。

自定义则需要实现接口：`ObjectFactory`，MyBatis默认抽象实现：`DefaultObjectFactory`

```xml
<objectFactory type="wang.angi.sample.mybatis.objectfactory.CustomObjectFactory">
</objectFactory>
```

### reflectorFactory

### objectWrapperFactory

### plugins



### environments

#### 数据库事务

#### 数据源



### databaseIdProvider



### mappers

```xml
<mappers>
  <!-- classpath relative -->
  <mapper resource="wang/angi/sample/mybatis/mapper/roleMapper.xml"/>
  <mapper url="file:///mybatis/mapper/roleMapper.xml"/>
  <!-- 基于Mapper接口 -->
  <mapper name="wang.angi.sample.mybatis.mapper.roleMapper"/>
  <!-- 基于Mapper接口所在包 -->
  <package name="wang.angi.sample.mybatis.mapper"/>
</mappers>
```



## SqlSessionFactoryBuilder



## SqlSessionFactory

一般采用单例模式创建

## SqlSession

类似JDBC中connection，非线程安全，随用随取，用完即毁。

```java
// 直接通过SqlSession操作，不需要mapper接口，iBatis遗留方式，MyBatis不推荐使用，而是推荐使用Mapper
SqlSession session = sqlSessionFactory.openSession();
try {
  // [namespace.]<sqlId>
  Blog blog = session.selectOne("org.mybatis.example.BlogMapper.selectBlog", 101);
}
finally {
  session.close();
}
```

## Mapper

非线程安全，从SQLSession获取，随用随取，用完即毁

```java
// 通过Mapper操作
SqlSession session = sqlSessionFactory.openSession();
try {
  BlogMapper mapper = session.getMapper(BlogMapper.class);
  Blog blog = mapper.selectBlog(101);
}
finally {
  session.close();
}
```



### Mapper接口

```java
public interface BlogMapper {
  Blog selectBlog(int id);
}
```

**备注：**如果直接使用SQLSession方式操作，可以不需要Mapper接口

### XML mapper

BlogMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.mybatis.example.BlogMapper">
  <select id="selectBlog" resultType="Blog">
     select * from Blog where id = #{id}
  </select>
</mapper>
```

### annotation mapper

直接在Mapper接口上定义sql statement

```java
public interface CityMapper {
    @Select("SELECT * FROM CITY WHERE state = #{state}")
    City findByState(@Param("state") String state);
}
```



### select

### insert

### update

### delete

### 参数

```
#{id,javaType=int,jdbcType=NUMERIC,numericScale=2}
```

```
# 存在SQL注入的风险
ORDER BY ${columnName}
```

#### 简单参数

```xml
<?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.mybatis.example.BlogMapper">
  <select id="selectBlog" resultType="Blog">
     select * from Blog where id = #{id}
  </select>
</mapper>
```

8种基本类型或包装类型的单个参数，可以不用指定`parameterType`。

#### Map

多个有名参数

#### JavaBean

过多的有名参赛

#### @Param

少于6个参数有名参数

#### 存储过程

mode=INT/OUT/INOUT

**备注：**parameterMap已经不推荐使用了

### 结果

#### resultType

#### resultMap

### sql

## 核心功能

### 自动映射

**autoMappingBehavior**：自动映射行为，默认值：PARTIAL

NONE

PARTIAL

FULL

**mapUnderscoreToCamelCase**：是否开启数据库下划线到Java驼峰命名规则映射，默认值false。比如：created_by《-》createdBy

### 级联

**lazyLoadingEnabled**：是否开启延时加载，全局，默认值：false

**aggressiveLazyLoading**：是否层级延时加载，全局，默认值：true

**fetchType**：级联获取模式，可取值：eager和lazy，用于`<association/>`和`<collection/>`，默认值由**aggressiveLazyLoading**决定

### 缓存

#### 一级缓存

SqlSession级别【SQLSessionTemplate和SQLSessionDaoSupport每次都获取新的SQLSession，因而无法支持一级缓存】，默认打开状态

#### 二级缓存

SqlSessionFactory级别，默认关闭状态，在XML Mapper里面增加`<cache/>`即可开启。

```shell
2018-01-10 14:02:29.924 DEBUG 10584 --- [           main] w.a.s.m.s.b.starter.mapper.CityMapper    : Cache Hit Ratio [wang.angi.sample.mybatis.spring.boot.starter.mapper.CityMapper]: 0.0
2018-01-10 14:02:29.924 DEBUG 10584 --- [           main] w.a.s.m.s.b.s.m.C.selectCityById         : ==>  Preparing: select * from city where id = ? 
2018-01-10 14:02:29.924 DEBUG 10584 --- [           main] w.a.s.m.s.b.s.m.C.selectCityById         : ==> Parameters: 1(Long)
2018-01-10 14:02:29.925 TRACE 10584 --- [           main] w.a.s.m.s.b.s.m.C.selectCityById         : <==    Columns: ID, NAME, STATE, COUNTRY
2018-01-10 14:02:29.925 TRACE 10584 --- [           main] w.a.s.m.s.b.s.m.C.selectCityById         : <==        Row: 1, San Francisco, CA, US
2018-01-10 14:02:29.925 DEBUG 10584 --- [           main] w.a.s.m.s.b.s.m.C.selectCityById         : <==      Total: 1
2018-01-10 14:02:29.927 DEBUG 10584 --- [           main] w.a.s.m.s.b.starter.mapper.CityMapper    : Cache Hit Ratio [wang.angi.sample.mybatis.spring.boot.starter.mapper.CityMapper]: 0.5
```

### 分页

#### RowBounds

MyBatis自带，内存分页

```java
List<Country> list = sqlSession.selectList("x.y.selectIf", null, new RowBounds(0, 10));
roleMapper.findRolesByName("role", new RowBounds(0,5));
```



#### 分页插件

##### [PageHelper](https://pagehelper.github.io)

```xml
	   <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper</artifactId>
            <version>5.1.2</version>
        </dependency>
```

```xml
    <plugins>
        <plugin interceptor="com.github.pagehelper.PageInterceptor"></plugin>
    </plugins>
```

###### 参数

分页插件可选参数如下：

- `dialect`：默认情况下会使用 PageHelper 方式进行分页，如果想要实现自己的分页逻辑，可以实现 `Dialect`(`com.github.pagehelper.Dialect`)接口，然后配置该属性为实现类的全限定名称。

**下面几个参数都是针对默认 dialect 情况下的参数。使用自定义 dialect 实现时，下面的参数没有任何作用。**

1. `helperDialect`：分页插件会自动检测当前的数据库链接，自动选择合适的分页方式。
   你可以配置`helperDialect`属性来指定分页插件使用哪种方言。配置时，可以使用下面的缩写值：
   `oracle`,`mysql`,`mariadb`,`sqlite`,`hsqldb`,`postgresql`,`db2`,`sqlserver`,`informix`,`h2`,`sqlserver2012`,`derby`
   **特别注意：**使用 SqlServer2012 数据库时，需要手动指定为 `sqlserver2012`，否则会使用 SqlServer2005 的方式进行分页。
   你也可以实现 `AbstractHelperDialect`，然后配置该属性为实现类的全限定名称即可使用自定义的实现方法。
2. `offsetAsPageNum`：默认值为 `false`，该参数对使用 `RowBounds` 作为分页参数时有效。当该参数设置为 `true` 时，会将 `RowBounds` 中的 `offset` 参数当成 `pageNum` 使用，可以用页码和页面大小两个参数进行分页。
3. `rowBoundsWithCount`：默认值为`false`，该参数对使用 `RowBounds` 作为分页参数时有效。当该参数设置为`true`时，使用 `RowBounds` 分页会进行 count 查询。
4. `pageSizeZero`：默认值为 `false`，当该参数设置为 `true` 时，如果 `pageSize=0` 或者 `RowBounds.limit = 0` 就会查询出全部的结果（相当于没有执行分页查询，但是返回结果仍然是 `Page` 类型）。
5. `reasonable`：分页合理化参数，默认值为`false`。当该参数设置为 `true` 时，`pageNum<=0` 时会查询第一页，`pageNum>pages`（超过总数时），会查询最后一页。默认`false` 时，直接根据参数进行查询。
6. `params`：为了支持`startPage(Object params)`方法，增加了该参数来配置参数映射，用于从对象中根据属性名取值，可以配置 `pageNum,pageSize,count,pageSizeZero,reasonable`，不配置映射的用默认值，默认值为`pageNum=pageNum;pageSize=pageSize;count=countSql;reasonable=reasonable;pageSizeZero=pageSizeZero`。
7. `supportMethodsArguments`：支持通过 Mapper 接口参数来传递分页参数，默认值`false`，分页插件会从查询方法的参数值中，自动根据上面 `params` 配置的字段中取值，查找到合适的值时就会自动分页。使用方法可以参考测试代码中的 `com.github.pagehelper.test.basic` 包下的 `ArgumentsMapTest` 和 `ArgumentsObjTest`。
8. `autoRuntimeDialect`：默认值为 `false`。设置为 `true` 时，允许在运行时根据多数据源自动识别对应方言的分页（不支持自动选择`sqlserver2012`，只能使用`sqlserver`），用法和注意事项参考下面的**场景五**。
9. `closeConn`：默认值为 `true`。当使用运行时动态数据源或没有设置 `helperDialect` 属性自动获取数据库类型时，会自动获取一个数据库连接，通过该属性来设置是否关闭获取的这个连接，默认`true`关闭，设置为 `false` 后，不会关闭获取的连接，这个参数的设置要根据自己选择的数据源来决定。

**重要提示：**

当 `offsetAsPageNum=false` 的时候，由于 `PageNum` 问题，`RowBounds`查询的时候 `reasonable` 会强制为 `false`。使用 `PageHelper.startPage` 方法不受影响。

###### 用法

* ```java
  //第一种，RowBounds方式的调用
  List<Country> list = sqlSession.selectList("x.y.selectIf", null, new RowBounds(0, 10));
  ```


* ```java
  //第二种，Mapper接口方式的调用，推荐这种使用方式。
  PageHelper.startPage(1, 10);
  List<Country> list = countryMapper.selectIf(1);
  ```

* ```java
  //第三种，Mapper接口方式的调用，推荐这种使用方式。
  PageHelper.offsetPage(1, 10);
  List<Country> list = countryMapper.selectIf(1);
  ```

* ```java
  //第四种，参数方法调用
  //存在以下 Mapper 接口方法，你不需要在 xml 处理后两个参数
  public interface CountryMapper {
      List<Country> selectByPageNumSize(
              @Param("user") User user,
              @Param("pageNum") int pageNum,
              @Param("pageSize") int pageSize);
  }
  //配置supportMethodsArguments=true
  //在代码中直接调用：
  List<Country> list = countryMapper.selectByPageNumSize(user, 1, 10);
  ```

* ```java
  //第五种，参数对象
  //如果 pageNum 和 pageSize 存在于 User 对象中，只要参数有值，也会被分页
  //有如下 User 对象
  public class User {
      //其他fields
      //下面两个参数名和 params 配置的名字一致
      private Integer pageNum;
      private Integer pageSize;
  }
  //存在以下 Mapper 接口方法，你不需要在 xml 处理后两个参数
  public interface CountryMapper {
      List<Country> selectByPageNumSize(User user);
  }
  //当 user 中的 pageNum!= null && pageSize!= null 时，会自动分页
  List<Country> list = countryMapper.selectByPageNumSize(user);
  ```

  如果基于spring boot，则仅需要添加如下依赖：

  ```xml
      <dependency>
          <groupId>com.github.pagehelper</groupId>
          <artifactId>pagehelper-spring-boot-starter</artifactId>
          <version>1.2.3</version>
      </dependency>
  ```

  返回的`List<E>`其实是`Page<E>`

  配置前缀：pagehelper

## 动态SQL

`Criterion`：一个筛选条件，比如>、<、=、between、in等

`Criteria`：一组筛选条件，之间and关系

`List<Criteria> oredCriteria`：一组`Criteria`，之间or关系

## MyBatis Spring

[MyBatis-Spring](http://www.mybatis.org/spring/)

### SqlSessionFactoryBean

```xml
<bean id = "sqlSessionFactory" class = "org.mybatis.spring.SqlSessionFactoryBean">
	<property name="dataSource" ref="dataSource" />
</bean>

```

![img](/images/SqlSessionFactoryBean.png)

mapperLocations：支持通配符，比如：`classpath*:sqlmap/*-mapper.xml"`

**一般情况下，mybatis的配置文件可以不需要（mybatis-config.xml），如下情况可能需要（configLocation）：**

1. 需要定制`<settings>`，其实`configurationProperties`属性可以支持
2. 需要定制`<typeAliases>`，其实`typeHandlersPackage`属性可以支持
3. mapper xml和mapper class不在相同的classpath下，其实`mapperLocation`属性可以支持

mybatis配置文件中<environments>会被忽略。

### SqlSessionTemplate

SqlSession的一种实现，使用了代理模式，线程安全，由于每次都获取新的SQLSession，因而不支持一级缓存

```java
public class UserDaoImpl implements UserDao {
   private SqlSession sqlSession;
   public void setSqlSession(SqlSession sqlSession) {
     	this.sqlSession = sqlSession;
   }
   public User getUser(String userId) {
     	return (User) sqlSession.selectOne("org.mybatis.spring.sample.mapper.UserMapper.getUser", userId);
   }
}
```



```xml
<bean id = "sqlSession" class = "org.mybatis.spring.SqlSessionTemplate">
  <constructor-arg index="0" ref="sqlSessionFactory" />
</bean>

<bean id = "userDao" class = "org.mybatis.spring.sample.dao.UserDaoImpl">
  <property name="sqlSession" ref="sqlSession" />
</bean>
```



### SqlSessionDaoSupport

```java
public class UserDaoImpl extends SqlSessionDaoSupport implements UserDao {
	public User getUser (String userId) {
		return (User) getSqlSession().selectOne("org.mybatis.spring.sample.mapper.UserMapper.getUser",userId);
    }
}
```



```xml
<bean id="userMapper" class="org.mybatis.spring.sample.mapper.UserDaoImpl">
  <property name="sqlSessionFactory" ref="sqlSessionFactory" />
</bean>
```



### MapperFactoryBean

Spring中定义Mapper，线程安全，每次都获取新的SQLSession

```xml
<bean id = "userMapper" class = "org.mybatis.spring.mapper.MapperFactoryBean">
	<property name = "mapperInterface" value = "org.mybatis.spring.sample.mapper.UserMapper"/>
  	<property name = "sqlSessionFactory" ref= "sqlSessionFactory" />
</bean>
```

默认添加了依赖注入注解`@Autowired`

```java
public class MapperFactoryBean<T> extends SqlSessionDaoSupport implements FactoryBean<T>
```

```java
public abstract class SqlSessionDaoSupport extends DaoSupport {

  private SqlSession sqlSession;

  private boolean externalSqlSession;

  @Autowired(required = false)
  public final void setSqlSessionFactory(SqlSessionFactory sqlSessionFactory) {
    if (!this.externalSqlSession) {
      this.sqlSession = new SqlSessionTemplate(sqlSessionFactory);
    }
  }

  @Autowired(required = false)
  public final void setSqlSessionTemplate(SqlSessionTemplate sqlSessionTemplate) {
    this.sqlSession = sqlSessionTemplate;
    this.externalSqlSession = true;
  }
  ...
}
```



### Mapper Scan

基于扫描自动生产Mapper

`base-package`：

`factory-ref` or `template-ref`：

`annotation`：被此注解的mapper接口，比如@Mapper

`marker-interface`：实现此接口的mapper接口，比如MyMapper

**NOTE**：`<context:component-scan/>`  won't be able to scan and register mappers. Mappers are interfaces and, in order to register them to Spring, the scanner must know how to create a `MapperFactoryBean` for each interface it finds. 

#### `<mybatis:scan/>`

类似`<context:component-scan/>`

```xml
<mybatis:scan base-package="org.mybatis.spring.sample.mapper" />
```

#### @MapperScan

```java
@Configuration
@MapperScan("org.mybatis.spring.sample.mapper")
public class AppConfig {

  @Bean
  public DataSource dataSource() {
    return new EmbeddedDatabaseBuilder().addScript("schema.sql").build()
  }

  @Bean
  public SqlSessionFactory sqlSessionFactory() throws Exception {
    SqlSessionFactoryBean sessionFactory = new SqlSessionFactoryBean();
    sessionFactory.setDataSource(dataSource());
    return sessionFactory.getObject();
  }
}
```

#### MapperScannerConfigurer

推荐使用`sqlSessionFactoryBean`和`sqlSessionTemplateBean`，如果没有显示注入，由于开启了按类型自动注入，则会自动注入，参见如下源代码：

`org.mybatis.spring.mapper.ClassPathMapperScanner.processBeanDefinitions(Set<BeanDefinitionHolder>)`

```java
      if (!explicitFactoryUsed) {
        if (logger.isDebugEnabled()) {
          logger.debug("Enabling autowire by type for MapperFactoryBean with name '" + holder.getBeanName() + "'.");
        }
        definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);
      }
```



## MyBatis Spring Boot Starter

[MyBatis-Spring-Boot-Starter](http://www.mybatis.org/spring-boot-starter/)，有助于快速构建基于MyBatis的Spring Boot应用。

自动发现DataSource

创建并注册一个`SqlSessionFactory`实例

创建并注册一个`SqlSessionTemplate`实例

自动扫描@Mapper注解的接口为Mapper

```xml
<dependency>
    <groupId>org.mybatis.spring.boot</groupId>
    <artifactId>mybatis-spring-boot-starter</artifactId>
    <version>2.0.0-SNAPSHOT</version>
</dependency>
```



```java
@Mapper
public interface CityMapper {
	// annotation mapper
    @Select("SELECT * FROM CITY WHERE state = #{state}")
    City findByState(@Param("state") String state);

}
```



```java
@SpringBootApplication
public class SampleMybatisApplication implements CommandLineRunner {

    private final CityMapper cityMapper;

    public SampleMybatisApplication(CityMapper cityMapper) {
        this.cityMapper = cityMapper;
    }

    public static void main(String[] args) {
        SpringApplication.run(SampleMybatisApplication.class, args);
    }

    @Override
    public void run(String... args) throws Exception {
        System.out.println(this.cityMapper.findByState("CA"));
    }

}
```



### 配置

对应配置类：`MybatisProperties`，mybatis前缀

| Property                   | Description                              |
| -------------------------- | ---------------------------------------- |
| `config-location`          | Location of MyBatis xml config file.     |
| `check-config-location`    | Indicates whether perform presence check of the MyBatis xml config file. |
| `mapper-locations`         | Locations of Mapper xml config file.【支持通配符】 |
| `type-aliases-package`     | Packages to search for type aliases. (Package delimiters are "`,; \t\n`") |
| `type-handlers-package`    | Packages to search for type handlers. (Package delimiters are "`,; \t\n`") |
| `executor-type`            | Executor type: `SIMPLE`, `REUSE`, `BATCH`. |
| `configuration-properties` | Externalized properties for MyBatis configuration. Specified properties can be used as placeholder on MyBatis config file and Mapper file.		      For detail see the [MyBatis reference page](http://www.mybatis.org/mybatis-3/configuration.html#properties) |
| `configuration`            | A MyBatis `Configuration` bean. About available properties see the [MyBatis reference page](http://www.mybatis.org/mybatis-3/configuration.html#settings).		      NOTE This property cannot be used at the same time with the `config-location`. |

mybatis.configuration与mybatis.config-location不能同时使用

7个非mybatis.configuration属性

49个mybatis.configuration属性

```properties
# application.properties
mybatis.type-aliases-package=com.example.domain.model
mybatis.type-handlers-package=com.example.typehandler
mybatis.configuration.map-underscore-to-camel-case=true
mybatis.configuration.default-fetch-size=100
mybatis.configuration.default-statement-timeout=30
mybatis.mapper-locations=classpath*:**/mapper/*.xml
```

### ConfigurationCustomizer

```java
// @Configuration class
@Bean
ConfigurationCustomizer mybatisConfigurationCustomizer() {
    return new ConfigurationCustomizer() {
        @Override
        public void customize(Configuration configuration) {
            // customize ...
        }
    };
}
```
