---
layout: post
title: "实践gitlab"
date: 2017-08-30 17:08:00 +0800
categories: 工具
tags: tool gitlab
---

## Gitlab

### 介绍

[gitlab](http://gitlab.com/)

### 二进制发行包

#### 安装

下载适合操作系统和CPU架构的二进制包，然后安装即可，例如：

```shell
$ sudo rpm -ivh gitlab-ce-9.5.2-ce.0.el6.x86_64.rpm
```

默认安装到`/opt/gitlab`目录下，配置文件`/etc/gitlab/gitlab.rb`。

#### 命令

```shell
$ gitlab-ctl help
omnibus-ctl: command (subcommand)
deploy-page
  Put up the deploy page
diff-config
  Compare the user configuration with package available configuration
remove-accounts
  Delete *all* users and groups used by this package
upgrade
  Run migrations after a package upgrade
General Commands:
  cleanse
    Delete *all* gitlab data, and start from scratch.
  help
    Print this help message.
  reconfigure
    Reconfigure the application.
  show-config
    Show the configuration that would be generated by reconfigure.
  uninstall
    Kill all processes and uninstall the process supervisor (data will be preserved).
Service Management Commands:
  graceful-kill
    Attempt a graceful stop, then SIGKILL the entire process group.
  hup
    Send the services a HUP.
  int
    Send the services an INT.
  kill
    Send the services a KILL.
  once
    Start the services if they are down. Do not restart them if they stop.
  restart
    Stop the services if they are running, then start them again.
  service-list
    List all the services (enabled services appear with a *.)
  start
    Start services if they are down, and restart them if they stop.
  status
    Show the status of all the services.
  stop
    Stop the services, and do not restart them.
  tail
    Watch the service logs of all enabled services.
  term
    Send the services a TERM.
  usr1
    Send the services a USR1.
  usr2
    Send the services a USR2.
Container Registry Commands:
  registry-garbage-collect
    Run Container Registry garbage collection.
Database Commands:
  pg-upgrade
    Upgrade the PostgreSQL DB to the latest supported version
  revert-pg-upgrade
    Run this to revert to the previous version of the database
```

#### 启动

```shell
$ sudo gitlab-ctl start
```

#### 刷新配置
修改配置后，刷新使生效。
```shell
$ sudo gitlab-ctl reconfigure
```
#### 配置gitlab地址
修改配置文件中的`external_url`为gitlab的访问地址。

#### smtp配置
可以参见[官方](https://docs.gitlab.com/omnibus/settings/smtp.html#qq-exmail)
```
gitlab_rails['smtp_enable'] = true
gitlab_rails['smtp_address'] = "smtp.exmail.qq.com"
gitlab_rails['smtp_port'] = 465
gitlab_rails['smtp_user_name'] = "gitlab@koolyun.com"
gitlab_rails['smtp_password'] = "******"
gitlab_rails['smtp_domain'] = "koolyun.com"
gitlab_rails['smtp_authentication'] = "login"
gitlab_rails['smtp_enable_starttls_auto'] = true
gitlab_rails['smtp_tls'] = true

gitlab_rails['gitlab_email_from'] = 'gitlab@koolyun.com'
```
测试验证
```
gitlab-rails console
```

```
Notify.test_email('wanglei@koolyun.com', 'Message Subject', 'Message Body').deliver_now
```

#### reply to email配置
参见[官方](https://docs.gitlab.com/ee/administration/reply_by_email.html)，没有成功。

#### 备份还原
备份
```shell
$ sudo gitlab-rake gitlab:backup:create
[sudo] password for wanglei: 
Dumping database ... 
Dumping PostgreSQL database gitlabhq_production ... [DONE]
done
Dumping repositories ...
 * demo/sample-project ... [DONE]
 * demo/sample-project.wiki ...  [SKIPPED]
 * docs/training ... [SKIPPED]
 * docs/training.wiki ...  [SKIPPED]
 * docs/wiki ... [DONE]
 * docs/wiki.wiki ...  [DONE]
 * wanglei/demo ... [DONE]
 * wanglei/demo.wiki ...  [SKIPPED]
 * chenlong/test ... [DONE]
 * chenlong/test.wiki ...  [SKIPPED]
 * chenlong/test2 ... [DONE]
 * chenlong/test2.wiki ...  [SKIPPED]
 * demo/servlet ... [DONE]
 * demo/servlet.wiki ...  [SKIPPED]
 * my-test/cib-epay-demo ... [DONE]
 * my-test/cib-epay-demo.wiki ...  [SKIPPED]
done
Dumping uploads ... 
done
Dumping builds ... 
done
Dumping artifacts ... 
done
Dumping pages ... 
done
Dumping lfs objects ... 
done
Dumping container registry images ... 
[DISABLED]
Creating backup archive: 1508408387_2017_10_19_10.0.4_gitlab_backup.tar ... done
Uploading backup archive to remote storage  ... skipped
Deleting tmp directories ... done
done
done
done
done
done
done
done
Deleting old backups ... skipping
```

#### 升级

```
# Debian/Ubuntu
dpkg -i gitlab-ce-XXX.deb

# CentOS/RHEL
rpm -Uvh gitlab-ce-XXX.rpm
```

例如：

```shell
$ sudo rpm -Uvh gitlab-ce-10.0.1-ce.0.el6.x86_64.rpm
warning: gitlab-ce-10.0.1-ce.0.el6.x86_64.rpm: Header V4 RSA/SHA1 Signature, key ID f27eab47: NOKEY
Preparing...                ########################################### [100%]
gitlab preinstall: Automatically backing up only the GitLab SQL database (excluding everything else!)
Dumping database ... 
Dumping PostgreSQL database gitlabhq_production ... [DONE]
done
Dumping repositories ...
[SKIPPED]
Dumping uploads ... 
[SKIPPED]
Dumping builds ... 
[SKIPPED]
Dumping artifacts ... 
[SKIPPED]
Dumping pages ... 
[SKIPPED]
Dumping lfs objects ... 
[SKIPPED]
Dumping container registry images ... 
[DISABLED]
Creating backup archive: 1506410179_2017_09_26_9.5.2_gitlab_backup.tar ... done
Uploading backup archive to remote storage  ... skipped
Deleting tmp directories ... done
done
Deleting old backups ... skipping
   1:gitlab-ce              ########################################### [100%]
Checking PostgreSQL executables:Starting Chef Client, version 12.12.15
resolving cookbooks for run list: ["gitlab::postgresql-bin"]
Synchronizing Cookbooks:
  - gitlab (0.0.1)
  - registry (0.1.0)
  - package (0.1.0)
  - consul (0.0.0)
  - runit (0.14.2)
Installing Cookbook Gems:
Compiling Cookbooks...
Converging 1 resources
Recipe: gitlab::postgresql-bin
  * ruby_block[Link postgresql bin files to the correct version] action run (skipped due to only_if)

Running handlers:
Running handlers complete
Chef Client finished, 0/1 resources updated in 07 seconds
Checking PostgreSQL executables: OK
Shutting down all GitLab services except those needed for migrations
ok: down: gitaly: 0s, normally up, want up
ok: down: gitlab-monitor: 0s, normally up
ok: down: gitlab-workhorse: 1s, normally up
ok: down: logrotate: 0s, normally up
ok: down: nginx: 0s, normally up
ok: down: node-exporter: 1s, normally up
ok: down: postgres-exporter: 0s, normally up
ok: down: postgresql: 0s, normally up
ok: down: prometheus: 1s, normally up
ok: down: redis: 0s, normally up
ok: down: redis-exporter: 0s, normally up
ok: down: sidekiq: 1s, normally up
ok: down: unicorn: 0s, normally up
ok: run: postgresql: (pid 4957) 1s
ok: run: redis: (pid 4967) 0s
run: postgresql: (pid 4957) 1s; run: log: (pid 7888) 1111069s
run: redis: (pid 4967) 0s; run: log: (pid 7824) 1111080s
Reconfiguring GitLab to apply migrations
Starting Chef Client, version 12.12.15
resolving cookbooks for run list: ["gitlab"]
Synchronizing Cookbooks:
  - gitlab (0.0.1)
  - package (0.1.0)
  - registry (0.1.0)
  - consul (0.0.0)
  - runit (0.14.2)
Installing Cookbook Gems:
...
Running handlers:
Running handlers complete
Chef Client finished, 20/475 resources updated in 01 minutes 21 seconds
gitlab Reconfigured!
Checking for an omnibus managed postgresql: OK
Checking if we already upgraded: NOT OK
Checking for a newer version of PostgreSQL to install: NOT OK
No new version of PostgreSQL installed, nothing to upgrade to
Ensuring PostgreSQL is updated: OK
Restarting previously running GitLab services
ok: run: gitaly: (pid 5545) 0s
ok: run: gitlab-monitor: (pid 5558) 1s
ok: run: gitlab-workhorse: (pid 5525) 2s
ok: run: logrotate: (pid 5562) 0s
ok: run: nginx: (pid 5572) 1s
ok: run: node-exporter: (pid 5590) 0s
ok: run: postgres-exporter: (pid 5601) 0s
ok: run: postgresql: (pid 4957) 88s
ok: run: prometheus: (pid 5614) 1s
ok: run: redis: (pid 4967) 88s
ok: run: redis-exporter: (pid 5625) 0s
ok: run: sidekiq: (pid 5651) 1s
ok: run: unicorn: (pid 5656) 0s

     _______ __  __          __
    / ____(_) /_/ /   ____ _/ /_
   / / __/ / __/ /   / __ \`/ __ \
  / /_/ / / /_/ /___/ /_/ / /_/ /
  \____/_/\__/_____/\__,_/_.___/
  

Upgrade complete! If your GitLab server is misbehaving try running
  sudo gitlab-ctl restart
before anything else.
If you need to roll back to the previous version you can use the database
backup made during the upgrade (scroll up for the filename).
```

### 包管理器

#### 升级

```
# Debian/Ubuntu
sudo apt-get update
sudo apt-get install gitlab-ce

# Centos/RHEL
sudo yum install gitlab-ce
```

## Gitlab权限

### 可见权限

可见权限有三个级别:

* Private: Project access must be granted explicitly to each user (Member).
* Internal: The project can be accessed by any logged in user.
* Public: The project can be accessed without any authentication.

group和project均有，project可见级别不能高于group。

### 操作权限

操作权限有五个级别：

Guest
Reporter
Developer
Master
Owner

group和project均可设置，取两者最高者。

## Gitlab CI/CD

[gitlab-ci/cd](https://about.gitlab.com/features/gitlab-ci-cd/)

## Gitlab Runner

10.0版本之前叫gitlab-ci-multi-runner，之后重命名为gitlab-runner

### 通过二进制发行包安装

下载适合操作系统和CPU平台架构的二进制包，然后安装即可，例如：

```shell
$ sudo rpm -ivh gitlab-runner-10.0.0-1.x86_64.rpm
```

默认安装到/opt/gitlab目录下，配置文件/etc/gitlab-runner/config.toml

### 通过包管理器安装

#### Add GitLab's official repository:

**For GitLab Runner 10.0 and newer**

```
# For Debian/Ubuntu
curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.deb.sh | sudo bash

# For RHEL/CentOS
curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.rpm.sh | sudo bash
```

**For versions older than 10.0, please use**

```
# For Debian/Ubuntu
curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-ci-multi-runner/script.deb.sh | sudo bash

# For RHEL/CentOS
curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-ci-multi-runner/script.rpm.sh | sudo bash
```

####　Install gitlab-runner

For GitLab Runner 10.0 and newer**

```
# For Debian/Ubuntu
sudo apt-get install gitlab-runner

# For RHEL/CentOS
sudo yum install gitlab-runner
```

**For versions older than 10.0, please use**

```
# For Debian/Ubuntu
sudo apt-get install gitlab-ci-multi-runner

# For RHEL/CentOS
sudo yum install gitlab-ci-multi-runner
```



### Register the runner

```shell
$ sudo gitlab-runner register
```
### 命令

```shell
$ gitlab-runner help
NAME:
   gitlab-runner - a GitLab Runner

USAGE:
   gitlab-runner [global options] command [command options] [arguments...]

VERSION:
   10.0.2 (a9a76a50)

AUTHOR:
   GitLab Inc. <support@gitlab.com>

COMMANDS:
     exec                  execute a build locally
     list                  List all configured runners
     run                   run multi runner service
     register              register a new runner
     install               install service
     uninstall             uninstall service
     start                 start service
     stop                  stop service
     restart               restart service
     status                get status of a service
     run-single            start single runner
     unregister            unregister specific runner
     verify                verify all registered runners
     artifacts-downloader  download and extract build artifacts (internal)
     artifacts-uploader    create and upload build artifacts (internal)
     cache-archiver        create and upload cache artifacts (internal)
     cache-extractor       download and extract cache artifacts (internal)
     help, h               Shows a list of commands or help for one command

GLOBAL OPTIONS:
   --debug                      debug mode [$DEBUG]
   --log-level value, -l value  Log level (options: debug, info, warn, error, fatal, panic)
   --cpuprofile value           write cpu profile to file [$CPU_PROFILE]
   --help, -h                   show help
   --version, -v                print the version
```

