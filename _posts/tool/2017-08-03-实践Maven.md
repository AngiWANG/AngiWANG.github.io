---
layout: post
title: "实践Maven"
date: 2017-08-03 16:03:13 +0800
categories: 工具
tags: maven tool build
---

## 介绍

[Maven](https://maven.apache.org/)是一个构建工具，类似ant/gradle

## 安装

*详情可以参考[官方安装说明](https://maven.apache.org/install.html)*

### 二进制发行包

到官方下载二进制发行包，解压缩，设定环境变量即可。

### 通过包管理器

*nix系统可以使用SDKMAN，Mac可以使用Homebrew，Windows可以使用Scoop

```shell
$ sdk install gradle 4.0
```

```shell
$ gradle -v

------------------------------------------------------------
Gradle 4.0
------------------------------------------------------------

Build time:   2017-06-14 15:11:08 UTC
Revision:     316546a5fcb4e2dfe1d6aa0b73a4e09e8cecb5a5

Groovy:       2.4.11
Ant:          Apache Ant(TM) version 1.9.6 compiled on June 29 2015
JVM:          1.8.0_101 (Oracle Corporation 25.101-b13)
OS:           Linux 4.9.0-deepin6-amd64 amd64
```

## pom.xml

```
jar {
    baseName = 'sample-gradle'
    version =  '0.1.0'
}
```

### 插件（Plugins）

插件是实际执行任务或目标（goals）的集合，可以**直接使用**。也可以绑定到生命周期中（添加到pom.xml的build-》plugins下），由流程驱动执行。

插件一般都有一个help的目标，用来显示插件的**基本信息**和包含的**goals**等。

```shell
$ mvn org.springframework.boot:spring-boot-maven-plugin:help
```

可以查看更详细的信息，比如**参数**等，以及**指定goal**

```shell
$ mvn org.springframework.boot:spring-boot-maven-plugin:help -Ddetail=true -Dgoal=run
```

更详细信息可以使用下面常用插件中介绍的**maven-help-plugin**

插件前缀（plugin-prefix）：简化插件的标示，如果插件的artifactId命名符合规范：{plugin-prefix}-maven-plugin或{plugin-prefix}-maven-plugin可会自动识别插件前缀，也可以通过*goalPrefix*自定义插件前缀。

插件解析时，默认groupId取值为org.apache.maven.plugins和org.codehaus.mojo，可以通过settings.xml中新增其他groupId，否则会报找不到指定插件前缀的插件。

```xml
<settings>
  	<pluginGroups>
		<pluginGroup>org.springframework.boot</pluginGroup>
	</pluginGroups>
</settings>
```

```shell
$ mvn spring-boot:help
```

### 依赖

```
dependencies {
    compile "joda-time:joda-time:2.2"
}
```



### 仓库



```

```

maven本地仓库默认路径：${home}/.m2/

安装构建到本地仓库，例如：

```shell
$ mvn install:install-file -DgroupId=com.oracle -DartifactId=ojdbc14 -Dversion=10.2.0.2.0 -Dpackage=jar -Dfile=d:\ojdbc14.jar
```



### 继承

#### 超级POM

%mavan_home%/lib/maven-model-builder-3.0.4.jar

org/apache/maven/model/pom-4.0.0.xml



## Maven Wrapper1

Maven Wrapper的作用是将maven的版本纳入项目管理中，实现maven的版本由项目控制，与运行环境无关。首次运行时自动下载相应版本的maven到当前环境，升级也会非常容易。不会使用当前环境已安装的maven。

### 安装

有如下两种方法，区别主要再生成的目录，一个是mvn，另一个是.mvn，参照gradle wrapper，更倾向于方法一生成mvn目录，便于版本管理

#### 方法一

参考：[maven-wrapper](https://github.com/rimerosolutions/maven-wrapper/)

```shell
# 通过wrapper目标初始化maven wrapper
$ mvn -N com.rimerosolutions.maven.plugins.wrapper:wrapper
```

默认使用当前环境的maven版本，也可以通过如下配置定制，比如指定maven版本

```shell
$ mvn -N com.rimerosolutions.maven.plugins.wrapper:wrapper -DmavenVersion=3.5.0
# -DbaseDistributionUrl: 指定maven下载路径
```

```shell
# 生成如下maven wrapper相关文件，将这些文件添加到版本管理。
└── sample-gradle
    └── mvnw
    └── mvnw.bat
    └── mvn
        └── wrapper
            └── maven-wrapper.jar
            └── maven-wrapper.properties
```

maven-wrapper.properties中可以指定maven下载路径（可以使用相对目录），比如：

```properties
distributionUrl=https://repo1.maven.org/maven2/org/apache/maven/apache-maven/3.5.0/apache-maven-3.5.0-bin.zip
```

#### 方法二

参考：[maven-wrapper](https://github.com/takari/maven-wrapper),[takari-maven-plugin](https://github.com/takari/takari-maven-plugin)

```shell
# 通过wrapper目标初始化maven wrapper
$ mvn -N io.takari:maven:wrapper
```
默认使用最新稳定版本作为maven wrapper的maven版本，也可以通过如下配置定制，比如指定maven版本
```shell
$ mvn -N io.takari:maven:wrapper -Dmaven=3.3.9
# -DdistributionUrl: 指定maven下载路径
```

```shell
# 生成如下maven wrapper相关文件，将这些文件添加到版本管理。
└── sample-gradle
    └── mvnw
    └── mvnw.bat
    └── .mvn
        └── wrapper
            └── maven-wrapper.jar
            └── maven-wrapper.properties
```
maven-wrapper.properties中可以指定maven下载路径（可以使用相对目录），比如：

```properties
distributionUrl=https://repo1.maven.org/maven2/org/apache/maven/apache-maven/3.5.0/apache-maven-3.5.0-bin.zip
```

### 使用

```shell
# 使用mvnw命令代替原始的mvn
$ ./mvnv -v
```
首次会自动下载相应版本的maven，存放在~/.m2/wrapper/dists
### 升级
指定新版本的maven，重新安装即可【生成的相关文件可能会变化】

## properties

### plugin属性

```shell
$ mvn compiler:help -Ddetail=true -Dgoal=compile
[INFO] Scanning for projects...
[INFO]                                                                         
[INFO] ------------------------------------------------------------------------
[INFO] Building sample-spring-javaconfig 0.0.1-SNAPSHOT
[INFO] ------------------------------------------------------------------------
[INFO] 
[INFO] --- maven-compiler-plugin:2.3.2:help (default-cli) @ sample-spring-javaconfig ---
[INFO] org.apache.maven.plugins:maven-compiler-plugin:2.3.2

Maven Compiler Plugin
  The Compiler Plugin is used to compile the sources of your project.

compiler:compile
  Compiles application sources

  Available parameters:

    annotationProcessors
      Names of annotation processors to run. Only applies to JDK 1.6+ If not
      set, the default annotation processors discovery process applies.

    compilerArgument
      Sets the unformatted argument string to be passed to the compiler if fork
      is set to true.
      
      This is because the list of valid arguments passed to a Java compiler
      varies based on the compiler version.

    compilerArguments
      Sets the arguments to be passed to the compiler (prepending a dash) if
      fork is set to true.
      
      This is because the list of valid arguments passed to a Java compiler
      varies based on the compiler version.

    compilerId (Default: javac)
      The compiler id of the compiler to use. See this guide for more
      information.

    compilerVersion
      Version of the compiler to use, ex. '1.3', '1.5', if fork is set to true.

    debug (Default: true)
      Set to true to include debugging information in the compiled class files.

    debuglevel
      Keyword list to be appended to the -g command-line switch. Legal values
      are none or a comma-separated list of the following keywords: lines, vars,
      and source. If debuglevel is not specified, by default, nothing will be
      appended to -g. If debug is not turned on, this attribute will be ignored.

    encoding (Default: ${project.build.sourceEncoding})
      The -encoding argument for the Java compiler.

    excludes
      A list of exclusion filters for the compiler.

    executable
      Sets the executable of the compiler to use when fork is true.

    failOnError (Default: true)
      Indicates whether the build will continue even if there are compilation
      errors; defaults to true.

    fork (Default: false)
      Allows running the compiler in a separate process. If 'false' it uses the
      built in compiler, while if 'true' it will use an executable.

    generatedSourcesDirectory (Default:
    ${project.build.directory}/generated-sources/annotations)
      Specify where to place generated source files created by annotation
      processing. Only applies to JDK 1.6+

    includes
      A list of inclusion filters for the compiler.

    maxmem
      Sets the maximum size, in megabytes, of the memory allocation pool, ex.
      '128', '128m' if fork is set to true.

    meminitial
      Initial size, in megabytes, of the memory allocation pool, ex. '64', '64m'
      if fork is set to true.

    optimize (Default: false)
      Set to true to optimize the compiled code using the compiler's
      optimization methods.

    outputFileName
      Sets the name of the output file when compiling a set of sources to a
      single file.

    proc
      Sets whether annotation processing is performed or not. Only applies to
      JDK 1.6+ If not set, both compilation and annotation processing are
      performed at the same time.
      
      Allowed values are: none - no annotation processing is performed. only -
      only annotation processing is done, no compilation.

    showDeprecation (Default: false)
      Sets whether to show source locations where deprecated APIs are used.

    showWarnings (Default: false)
      Set to true to show compilation warnings.

    source (Default: 1.5)
      The -source argument for the Java compiler.

    staleMillis (Default: 0)
      Sets the granularity in milliseconds of the last modification date for
      testing whether a source needs recompilation.

    target (Default: 1.5)
      The -target argument for the Java compiler.

    verbose (Default: false)
      Set to true to show messages about what the compiler is doing.


[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 0.412s
[INFO] Finished at: Thu Aug 03 16:01:12 CST 2017
[INFO] Final Memory: 6M/240M
[INFO] ------------------------------------------------------------------------
```

则可以通过规则maven.{plugin-prefix}.parameter来定义属性，例如：

```xml
<maven.compiler.source>1.8</maven.compiler.source>
<maven.compiler.target>1.8</maven.compiler.target>
```

也可以通过命令行传递参数，例如：

```shell
$ mvn clean compile -Dsource=1.8 -Dtarget=1.8
```



## 常用插件

###  maven-help-plugin

比插件自带的help显示更多信息，包括**插件前缀**，**goal绑定生命周期**等。

```shell
$ mvn help:describe -Dplugin=spring-boot
# -Ddetail: 显示参数
$ mvn help:describe -Dplugin=spring-boot -Ddetail -Dgoal=run
```

