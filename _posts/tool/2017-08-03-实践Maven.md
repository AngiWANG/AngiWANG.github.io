---
layout: post
title: "实践Maven"
date: 2017-08-03 16:03:13 +0800
categories: 工具
tags: maven tool build
---

## 介绍

[Maven](https://maven.apache.org/)是一个构建工具，类似ant/gradle

## 安装

*详情可以参考[官方安装说明](https://maven.apache.org/install.html)*

### 二进制发行包

到官方下载二进制发行包，解压缩，设定环境变量即可。

### 通过包管理器

*nix系统可以使用SDKMAN，Mac可以使用Homebrew，Windows可以使用Scoop

```shell
$ sdk install gradle 4.0
```

```shell
$ gradle -v

------------------------------------------------------------
Gradle 4.0
------------------------------------------------------------

Build time:   2017-06-14 15:11:08 UTC
Revision:     316546a5fcb4e2dfe1d6aa0b73a4e09e8cecb5a5

Groovy:       2.4.11
Ant:          Apache Ant(TM) version 1.9.6 compiled on June 29 2015
JVM:          1.8.0_101 (Oracle Corporation 25.101-b13)
OS:           Linux 4.9.0-deepin6-amd64 amd64
```

## pom.xml

```
jar {
    baseName = 'sample-gradle'
    version =  '0.1.0'
}
```

### 插件（Plugins）

插件是实际执行任务或目标（goals）的集合，可以**直接使用**。也可以绑定到生命周期中（添加到pom.xml的build-》plugins下），由流程驱动执行。

插件一般都有一个help的目标，用来显示插件的**基本信息**和包含的**goals**等。

```shell
$ mvn org.springframework.boot:spring-boot-maven-plugin:help
```

可以查看更详细的信息，比如**参数**等，以及**指定goal**

```shell
$ mvn org.springframework.boot:spring-boot-maven-plugin:help -Ddetail=true -Dgoal=run
```

更详细信息可以使用下面常用插件中介绍的**maven-help-plugin**

插件前缀（plugin-prefix）：简化插件的标示，如果插件的artifactId命名符合规范：{plugin-prefix}-maven-plugin或maven-{plugin-prefix}-plugin可会自动识别插件前缀，也可以通过*goalPrefix*自定义插件前缀。

插件解析时，默认groupId取值为org.apache.maven.plugins和org.codehaus.mojo，可以通过settings.xml中新增其他groupId，否则会报找不到指定插件前缀的插件。

```xml
<settings>
  	<pluginGroups>
		<pluginGroup>org.springframework.boot</pluginGroup>
	</pluginGroups>
</settings>
```

```shell
$ mvn spring-boot:help
```

### 依赖

```
dependencies {
    compile "joda-time:joda-time:2.2"
}
```



### 仓库



```

```

maven本地仓库默认路径：${home}/.m2/

安装构建到本地仓库，例如：

```shell
$ mvn install:install-file -DgroupId=com.oracle -DartifactId=ojdbc14 -Dversion=10.2.0.2.0 -Dpackage=jar -Dfile=d:\ojdbc14.jar
```



### 继承

#### 超级POM

%mavan_home%/lib/maven-model-builder-3.0.4.jar/org/apache/maven/model/pom-4.0.0.xml

[中央仓库地址](http://repo.maven.apache.org/maven2)

## Maven Wrapper

Maven Wrapper的作用是将maven的版本纳入项目管理中，实现maven的版本由项目控制，与运行环境无关。首次运行时自动下载相应版本的maven到当前环境，升级也会非常容易。不会使用当前环境已安装的maven。

### 安装

有如下两种方法，区别主要再生成的目录，一个是.mvn，另一个是maven。

#### 方法一

参考：[maven-wrapper](https://github.com/takari/maven-wrapper),[takari-maven-plugin](https://github.com/takari/takari-maven-plugin)

```shell
# 通过wrapper目标初始化maven wrapper
$ mvn -N io.takari:maven:wrapper
```

默认使用最新稳定版本作为maven wrapper的maven版本，也可以通过如下配置定制，比如指定maven版本

```shell
$ mvn -N io.takari:maven:wrapper -Dmaven=3.3.9
# -DdistributionUrl: 指定maven下载路径
```

```shell
# 生成如下maven wrapper相关文件，将这些文件添加到版本管理。
└── sample-gradle
    └── mvnw
    └── mvnw.bat
    └── .mvn
        └── wrapper
            └── maven-wrapper.jar
            └── maven-wrapper.properties
```

maven-wrapper.properties中可以指定maven下载路径（可以使用相对目录），比如：

```properties
distributionUrl=https://repo1.maven.org/maven2/org/apache/maven/apache-maven/3.5.0/apache-maven-3.5.0-bin.zip
```

#### 方法二

参考：[maven-wrapper](https://github.com/rimerosolutions/maven-wrapper/)

添加plugin

```xml
<plugin>
	<groupId>com.rimerosolutions.maven.plugins</groupId>
	<artifactId>wrapper-maven-plugin</artifactId>
	<version>0.0.5</version>
</plugin>
```

```shell
# 通过wrapper目标初始化maven wrapper
$ mvn -N wrapper:wrapper
```

默认使用当前环境的maven版本，也可以通过如下配置定制，比如指定maven版本

```shell
$ mvn -N wrapper:wrapper -DmavenVersion=3.5.0
# -DbaseDistributionUrl: 指定maven下载路径
```

```shell
# 生成如下maven wrapper相关文件，将这些文件添加到版本管理。
└── sample-gradle
    └── mvnw
    └── mvnw.bat
    └── maven
        └── wrapper
            └── maven-wrapper.jar
            └── maven-wrapper.properties
```

maven-wrapper.properties中可以指定maven下载路径（可以使用相对目录），比如：

```properties
distributionUrl=https://repo1.maven.org/maven2/org/apache/maven/apache-maven/3.5.0/apache-maven-3.5.0-bin.zip
```

### 使用

```shell
# 使用mvnw命令代替原始的mvn
$ ./mvnv -v
```
首次会自动下载相应版本的maven，存放在~/.m2/wrapper/dists
### 升级
指定新版本的maven，重新安装即可【生成的相关文件可能会变化】

## properties

### <properties/>

```xml
<properties>
	<it.skip>false</it.skip>
</properties>
```

可以通过java系统属性提供更高优先级的设定，比如：-Dit.skip=true

### plugin属性

```shell
$ mvn help:describe -Dplugin=compiler -Dgoal=compile -Ddetail
[INFO] Scanning for projects...
[INFO] 
[INFO] ------------------------------------------------------------------------
[INFO] Building hello-client 0.0.1-SNAPSHOT
[INFO] ------------------------------------------------------------------------
[INFO] 
[INFO] --- maven-help-plugin:2.2:describe (default-cli) @ cts-hello-client ---
[INFO] Mojo: 'compiler:compile'
compiler:compile
  Description: Compiles application sources
  Implementation: org.apache.maven.plugin.compiler.CompilerMojo
  Language: java
  Bound to phase: compile

  Available parameters:

    annotationProcessors
      Names of annotation processors to run. Only applies to JDK 1.6+ If not
      set, the default annotation processors discovery process applies.

    compilerArgument
      Sets the unformatted single argument string to be passed to the compiler
      if fork is set to true. To pass multiple arguments such as -Xmaxerrs 1000
      (which are actually two arguments) you have to use compilerArguments.
      
      This is because the list of valid arguments passed to a Java compiler
      varies based on the compiler version.

    compilerArguments
      Sets the arguments to be passed to the compiler (prepending a dash) if
      fork is set to true.
      
      This is because the list of valid arguments passed to a Java compiler
      varies based on the compiler version.
      
      To pass -Xmaxerrs 1000 -Xlint -Xlint:-path -Averbose=true you should
      include the following:
      
      <compilerArguments>
        <Xmaxerrs>1000</Xmaxerrs>
        <Xlint/>
        <Xlint:-path/>
        <Averbose>true</Averbose>
      </compilerArguments>

    compilerId (Default: javac)
      User property: maven.compiler.compilerId
      The compiler id of the compiler to use. See this guide for more
      information.

    compilerReuseStrategy (Default: ${reuseCreated})
      User property: maven.compiler.compilerReuseStrategy
      Strategy to re use javacc class created:
      - reuseCreated (default): will reuse already created but in case of
        multi-threaded builds, each thread will have its own instance
      - reuseSame: the same Javacc class will be used for each compilation even
        for multi-threaded build
      - alwaysNew: a new Javacc class will be created for each compilation
      Note this parameter value depends on the os/jdk you are using, but the
      default value should work on most of env.

    compilerVersion
      User property: maven.compiler.compilerVersion
      Version of the compiler to use, ex. '1.3', '1.5', if fork is set to true.

    debug (Default: true)
      User property: maven.compiler.debug
      Set to true to include debugging information in the compiled class files.

    debuglevel
      User property: maven.compiler.debuglevel
      Keyword list to be appended to the -g command-line switch. Legal values
      are none or a comma-separated list of the following keywords: lines,
      vars, and source. If debug level is not specified, by default, nothing
      will be appended to -g. If debug is not turned on, this attribute will be
      ignored.

    encoding (Default: ${project.build.sourceEncoding})
      User property: encoding
      The -encoding argument for the Java compiler.

    excludes
      A list of exclusion filters for the compiler.

    executable
      User property: maven.compiler.executable
      Sets the executable of the compiler to use when fork is true.

    failOnError (Default: true)
      User property: maven.compiler.failOnError
      Indicates whether the build will continue even if there are compilation
      errors.

    forceJavacCompilerUse (Default: false)
      User property: maven.compiler.forceJavacCompilerUse
      compiler can now use javax.tools if available in your current jdk, you
      can disable this feature using
      -Dmaven.compiler.forceJavacCompilerUse=true or in the plugin
      configuration

    fork (Default: false)
      User property: maven.compiler.fork
      Allows running the compiler in a separate process. If false it uses the
      built in compiler, while if true it will use an executable.

    generatedSourcesDirectory (Default:
    ${project.build.directory}/generated-sources/annotations)
      Specify where to place generated source files created by annotation
      processing. Only applies to JDK 1.6+

    includes
      A list of inclusion filters for the compiler.

    maxmem
      User property: maven.compiler.maxmem
      Sets the maximum size, in megabytes, of the memory allocation pool, ex.
      '128', '128m' if fork is set to true.

    meminitial
      User property: maven.compiler.meminitial
      Initial size, in megabytes, of the memory allocation pool, ex. '64',
      '64m' if fork is set to true.

    mojoExecution
      User property: mojoExecution
      (no description available)

    optimize (Default: false)
      User property: maven.compiler.optimize
      Set to true to optimize the compiled code using the compiler's
      optimization methods.

    outputFileName
      Sets the name of the output file when compiling a set of sources to a
      single file.
      expression='${project.build.finalName}'

    proc
      Sets whether annotation processing is performed or not. Only applies to
      JDK 1.6+ If not set, both compilation and annotation processing are
      performed at the same time.
      
      Allowed values are:
      
      - none - no annotation processing is performed.
      - only - only annotation processing is done, no compilation.

    showDeprecation (Default: false)
      User property: maven.compiler.showDeprecation
      Sets whether to show source locations where deprecated APIs are used.

    showWarnings (Default: false)
      User property: maven.compiler.showWarnings
      Set to true to show compilation warnings.

    skipMultiThreadWarning (Default: false)
      User property: maven.compiler.skipMultiThreadWarning
      (no description available)

    source (Default: 1.5)
      User property: maven.compiler.source
      The -source argument for the Java compiler.

    staleMillis (Default: 0)
      User property: lastModGranularityMs
      Sets the granularity in milliseconds of the last modification date for
      testing whether a source needs recompilation.

    target (Default: 1.5)
      User property: maven.compiler.target
      The -target argument for the Java compiler.

    verbose (Default: false)
      User property: maven.compiler.verbose
      Set to true to show messages about what the compiler is doing.


[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 1.083 s
[INFO] Finished at: 2017-11-30T18:09:28+08:00
[INFO] Final Memory: 15M/303M
[INFO] ------------------------------------------------------------------------
```

则可以在pom中通过规则maven.{plugin-prefix}.parameter来定义属性，例如：

```xml
<properties>
	<maven.compiler.source>1.8</maven.compiler.source>
	<maven.compiler.target>1.8</maven.compiler.target>
</properties>
```

也可以通过命令行设置参数（只有User property支持命令行设置参数），例如：

```shell
$ mvn clean compile -Dmaven.test.skip=true
```



## 常用插件

###  maven-help-plugin

比插件自带的help显示更多信息，包括**插件前缀**，**goal绑定生命周期**，**参数的User property**等。

```shell
# 显示系统属性和环境变量
$ mvn help:system
# 显示spring-boot插件信息
$ mvn help:describe -Dplugin=spring-boot
# -Ddetail: 显示参数
$ mvn help:describe -Dplugin=spring-boot -Ddetail -Dgoal=run
```

### maven-surefire-plugin

-Dmaven.test.skip=true：跳过测试阶段

### maven-failsafe-plugin

[maven-failsafe-plugin](https://maven.apache.org/surefire/maven-failsafe-plugin/)集成测试

### maven-dependency-plugin

导出项目的依赖包

```shell
$ mvn dependency:copy-dependencies
```

| 参数                         | 描述                         |
| -------------------------- | -------------------------- |
| -Dmdep.useRepositoryLayout | 按坐标目录结构，默认值：false          |
| -DoutputDirectory          | 导出目录，默认值：target/dependency |
| -DincludeScope             | 导出指定级别的依赖                  |

includeScope (Default: )

      Scope to include. An Empty string indicates all scopes (default). The
      scopes being interpreted are the scopes as Maven sees them, not as
      specified in the pom. In summary:
      - runtime scope gives runtime and compile dependencies,
      - compile scope gives compile, provided, and system dependencies,
      - test (default) scope gives all dependencies,
      - provided scope just gives provided dependencies,
      - system scope just gives system dependencies.
      User property: includeScope