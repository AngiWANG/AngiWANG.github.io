---
layout: post
title: "实践MyBatis"
date: 2018-01-04 10:40:00 +0800
categories: 数据库
tags: database MyBatis JDBC ORM
---

[MyBatis](http://www.mybatis.org/mybatis-3/)【[MyBatis Blog](http://blog.mybatis.org/)】，前身是iBatis，是一个ORM框架

## mybatis-config.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE configuration PUBLIC "-//mybatis.org//DTD Config 3.0//EN" "http://mybatis.org/dtd/mybatis-3-config.dtd">
<configuration>
   <environments default="development">
     <environment id="development">
       <transactionManager type="JDBC"/>
       <dataSource type="POOLED">
         <property name="driver" value="${driver}"/>
         <property name="url" value="${url}"/>
         <property name="username" value="${username}"/>
         <property name="password" value="${password}"/>
       </dataSource>
     </environment>
   </environments>
   <mappers>
    <mapper resource="org/mybatis/example/BlogMapper.xml"/>
  </mappers>
</configuration>

```



```xml
<!ELEMENT configuration (properties?, settings?, typeAliases?, typeHandlers?, objectFactory?, objectWrapperFactory?, reflectorFactory?, plugins?, environments?, databaseIdProvider?, mappers?)>
```

### properties

```xml
<properties>
	<!-- 子元素 -->
	<property name="driver" value="com.mysql.jdbc.Driver"/>
</properties>
<!-- properties配置文件 -->
<properties resource="jdbc.properties"/>
<properties url="file:///properties/jdbc.properties"/>
```

### settings

```xml
<settings>
	<setting name="cachedEnabled" value="true"/>
</settings>
```

### typeAliases

MyBatis默认定义了一系列系统别名，也可以自定义别名，别名可以在MyBatis上下文中使用。不区分大小写。

```xml
<typeAliases>
    <!-- 精确定义 -->
	<typeAlias alias="role" type="wang.angi.sample.mybatis.dto.Role"/>
</typeAliases>

<typeAliases>
  	<!-- 基于扫描定义 -->
	<typeAlias package="wang.angi.sample.mybatis.dto"/>
</typeAliases>
```

### typeHandlers

类型处理器，在设置参数或结果集映射时会进行类型转换，主要是Java类型和JDBC类型（`org.apache.ibatis.type.JdbcType`）的互相转换，MyBatis默认定义了一系列系统类型处理器，也可以自定义类型处理器。

自定义类型处理器需要实现接口：`org.apache.ibatis.type.TypeHandler`，MyBatis默认抽象实现：`org.apache.ibatis.type.BaseTypeHandler`

```xml
<typeHandlers>
  	<typeHandler jdbcType="VARCHAR" javaType="string" handler="wang.angi.sample.mybatis.typehandler.MyStringTypeHandler"/>
</typeHandlers>
```

#### 枚举类型TypeHandler

EnumOrdinalTypeHandler：基于枚举下标传递参数

EnumTypeHandler：基于枚举名称传递参数

### objectFactory

当将结果集映射到POJO时，会基于ObjectFactory去构建。一般而言MyBatis默认定义的ObjectFactory可以满足需求。

自定义则需要实现接口：`ObjectFactory`，MyBatis默认抽象实现：`DefaultObjectFactory`

```xml
<objectFactory type="wang.angi.sample.mybatis.objectfactory.CustomObjectFactory">
</objectFactory>
```

### plugins



### environments

#### 数据库事务

#### 数据源



### databaseIdProvider



### mappers

```xml
<mappers>
	<mapper resource="wang/angi/sample/mybatis/mapper/roleMapper.xml"/>
  	<mapper url="file:///mybatis/mapper/roleMapper.xml"/>
  	<package name="wang.angi.sample.mybatis.mapper"/>
  	<mapper name="wang.angi.sample.mybatis.mapper.roleMapper.class"/>
</mappers>
```



## SqlSessionFactoryBuilder



## SqlSessionFactory

一般采用单例模式创建

## SqlSession

类似JDBC中connection，非线程安全，用完即毁

```java
// 直接通过SqlSession操作，iBatis遗留方式，MyBatis不推荐使用，而是推荐使用Mapper
SqlSession session = sqlSessionFactory.openSession();
try {
  Blog blog = session.selectOne("org.mybatis.example.BlogMapper.selectBlog", 101);
}
finally {
  session.close();
}
```



## Mapper

非线程安全，用完即毁

```java
// 通过Mapper操作
SqlSession session = sqlSessionFactory.openSession();
try {
  BlogMapper mapper = session.getMapper(BlogMapper.class);
  Blog blog = mapper.selectBlog(101);
}
finally {
  session.close();
}
```



### Mapper接口

```java
public interface BlogMapper {
  Blog selectBlog(int id);
}
```



### XML mapper

BlogMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?><!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.mybatis.example.BlogMapper">
  <select id="selectBlog" resultType="Blog">
     select * from Blog where id = #{id}
  </select>
</mapper>
```

### annotation mapper

### select

### insert

### update

### delete

### 参数

### resultMap

### sql

## 核心功能

### 自动映射

**autoMappingBehavior**：自动映射行为，默认值：PARTIAL

NONE

PARTIAL

FULL

**mapUnderscoreToCamelCase**：是否开启下划线到驼峰命名规则映射，默认值false

### 级联

**lazyLoadingEnabled**：是否开启延时加载，全局，默认值：false

**aggressiveLazyLoading**：是否层级延时加载，全局，默认值：true

**fetchType**：级联获取模式，可取值：eager和lazy，用于`<association/>`和`<collection/>`，默认值由**aggressiveLazyLoading**决定

### 缓存

#### 一级缓存

SqlSession级别，默认打开状态

#### 二级缓存

SqlSessionFactory级别，默认关闭状态

`<cache/>`

## MyBatis-Spring

[MyBatis-Spring](http://www.mybatis.org/spring/)

### SqlSessionFactoryBean

```xml
<bean id = "sqlSessionFactory" class = "org.mybatis.spring.SqlSessionFactoryBean">
	<property name="dataSource" ref="dataSource" />
</bean>

```

![img](/images/SqlSessionFactoryBean.png)

**一般情况下，mybatis的配置文件可以不需要（**configLocation**），但是**

One case where this is needed is if the base MyBatis configuration needs to be changed. Usually this will be `<settings>` or `<typeAliases>` sections.

Another reason to require a config file is if the MyBatis mapper XML files are not in the same classpath location as the mapper classes. With this configuration, there are two options. This first is to manually specify the classpath of the XML files using a `<mappers>` section in the MyBatis config file. A second option is to use the `mapperLocations` property of the factory bean.

Note that this config file does **not** need to be a complete MyBatis config. Specifically, any environments, data sources and MyBatis transaction managers will be **ignored** . `SqlSessionFactoryBean` creates its own, custom MyBatis `Environment` with these values set as required.

### SqlSessionTemplate

SqlSession的一种实现，线程安全

```java
public class UserDaoImpl implements UserDao {
   private SqlSession sqlSession;
   public void setSqlSession(SqlSession sqlSession) {
     	this.sqlSession = sqlSession;
   }
   public User getUser(String userId) {
     	return (User) sqlSession.selectOne("org.mybatis.spring.sample.mapper.UserMapper.getUser", userId);
   }
}
```



```xml
<bean id = "sqlSession" class = "org.mybatis.spring.SqlSessionTemplate">
  <constructor-arg index="0" ref="sqlSessionFactory" />
</bean>

<bean id = "userDao" class = "org.mybatis.spring.sample.dao.UserDaoImpl">
  <property name="sqlSession" ref="sqlSession" />
</bean>
```



### SqlSessionDaoSupport

```java
public class UserDaoImpl extends SqlSessionDaoSupport implements UserDao {
	public User getUser (String userId) {
		return (User) getSqlSession().selectOne("org.mybatis.spring.sample.mapper.UserMapper.getUser",userId);
    }
}
```



```xml
<bean id="userMapper" class="org.mybatis.spring.sample.mapper.UserDaoImpl">
  <property name="sqlSessionFactory" ref="sqlSessionFactory" />
</bean>
```



### MapperFactoryBean

Spring中定义Mapper

```xml
<bean id = "userMapper" class = "org.mybatis.spring.mapper.MapperFactoryBean">
	<property name = "mapperInterface" value = "org.mybatis.spring.sample.mapper.UserMapper"/>
  	<property name="sqlSessionFactory" ref="sqlSessionFactory" />
</bean>
```

### Mapper Scan

基于扫描自动生产Mapper

#### MapperScannerConfigurer

#### `<mybatis:scan/>`

#### @MapperScan



## MyBatis-Spring-Boot-Starter

[MyBatis-Spring-Boot-Starter](http://www.mybatis.org/spring-boot-starter/)